var geoForm=function(e,t){var o=this;this.options=jQuery.extend({},this.options,t);this.form=e;if(e.is("form")){this.topForm=e}else{this.topForm=e.parents("form:first")}this.sendCheck=jQuery(".geo-auto-detect",e).click(function(){o.enable.call(o)});jQuery(".geo-address-find",e).click(function(){return o.geocode()});jQuery(".geo-address",e).keypress(function(e){if(13!=e.keyCode){return true}return o.geocode()}).blur(function(){o.geocode()});var i=jQuery(".geo-enable").change(function(){if(jQuery(this).is(":checked")){o.form.show();o.initMap()}else{o.form.hide()}});if(!i.size()||i.is(":checked")){this.initMap()}this.setPosition=function(){return o._setPosition.apply(o,arguments)};this.handlePositionError=function(){return o._handlePositionError.apply(o,arguments)}};if("undefined"!=typeof navigator&&navigator.geolocation){geoForm.geolocation=navigator.geolocation}geoForm.geocodeSortLook={ROOFTOP:0,RANGE_INTERPOLATED:1,GEOMETRIC_CENTER:2,APPROXIMATE:3};geoForm.geocodeSort=function(e,t){return geoForm.geocodeSortLook[e.geometry.location_type]-geoForm.geocodeSortLook[t.geometry.location_type]};geoForm.prototype={form:null,topForm:null,options:{postName:"geo",error:null},sendCheck:null,map:false,mapInitialized:false,address:false,geocoding:false,position:false,fields:["latitude","longitude","accuracy"],marker:false,accuracyCircle:false,accuracyBound:false,zoomAccuracy:false,initMap:function(){if(this.mapInitialized){return}var e=this,t=jQuery(".geo-map",this.form);if(!t.is(":visible")){return}if(t.size()){var o=jQuery(".latitude",this.form),i=jQuery(".longitude",this.form),s=jQuery(".accuracy",this.form),a,r=new google.maps.LatLng(o.val()||o.attr("title")||o.text(),i.val()||i.attr("title")||i.text());this.map=new google.maps.Map(t.get(0),{zoom:this.options.zoom||0,center:r,mapTypeId:google.maps.MapTypeId.ROADMAP});google.maps.event.addListener(this.map,"click",function(t){this.marker=new google.maps.Marker({position:t.latLng,map:this.map});e.setFields(t.latLng);e.reverseGeocode(t.latLng)});a=s.val()||s.attr("title")||s.text();this.centerMap(r,a)}else{this.map=false}this.mapInitialized=true},enable:function(){this.preventSubmit();if(this.position){this.setPosition(this.position);this.allowSubmit()}else{geoForm.geolocation.getCurrentPosition(this.setPosition,this.handlePositionError,{timeout:6e3})}},_setPosition:function(e){var t=this;this.position=e;setTimeout(function(){var o=new google.maps.LatLng(e.coords.latitude,e.coords.longitude);t.reverseGeocode(o)},10);this.setFields(e.coords);this.allowSubmit();if(this.map){this.centerMap()}},setFields:function(e){var t=this,o,i,s,a;if(e.location_type&&e.bounds){o=e.location;a=new google.maps.LatLng(e.bounds.getSouthWest().lat(),e.bounds.getNorthEast().lng());i=(t.distance(e.bounds.getSouthWest(),a)+t.distance(e.bounds.getNorthEast(),a))/4;e=e.location}else if(e.location_type){o=e.location;i=false;e=e.location}else if(e.constructor==google.maps.LatLng){o=e;i=false}if(i<1){this.zoomAccuracy=i;i=false}else{this.zoomAccuracy=false}if(e.constructor==google.maps.LatLng){jQuery.each(this.fields,function(){if("latitude"==this){jQuery(".latitude",t.form).val(e.lat())}else if("longitude"==this){jQuery(".longitude",t.form).val(e.lng())}else if("accuracy"==this){jQuery(".accuracy",t.form).val(i)}else{jQuery("."+this,t.form).val("")}})}else{o=new google.maps.LatLng(e.latitude,e.longitude),i=e.accuracy;jQuery.each(this.fields,function(){var o="",i;if("undefined"!=typeof e[this]&&e[this]){o=e[this]}i=t.form.find("."+this);if(i.size()){i.val(o)}else{t.form.append('<input type="hidden" class="geo-field '+this+'" name="'+t.options.postName+"["+this+']" value="'+o+'" />')}})}if(!this.map){return}if(i){if(this.marker){this.marker.setMap();this.marker=false}this.drawCircle(this.map,o,parseInt(i)/1e3,100)}else{if(this.accuracyCircle){this.accuracyCircle.setMap();this.accuracyCircle=false}s={position:o,map:this.map};if(this.marker){this.marker.setOptions(s)}else{this.marker=new google.maps.Marker(s)}}},centerMap:function(e,t){if(!e){if(this.accuracyCircle){this.map.fitBounds(this.accuracyBound)}else if(this.marker){this.map.setCenter(this.marker.getPosition());if(this.zoomAccuracy){this.drawCircle(this.map,this.marker.getPosition(),parseInt(this.zoomAccuracy)/1e3,100);this.accuracyCircle.setMap();this.accuracyCircle=false;this.map.fitBounds(this.accuracyBound)}}return}if(t){if(0==t){if(this.marker){this.marker.setPosition(e);this.marker.setMap(this.map)}else{this.marker=new google.maps.Marker({position:e,map:this.map});this.map.setZoom(8)}}else{this.drawCircle(this.map,e,parseInt(t)/1e3,100);this.map.fitBounds(this.accuracyBound)}}this.map.setCenter(e)},_handlePositionError:function(e){this.allowSubmit();this.sendCheck.prop("checked",false);if("function"==typeof this.options.error){this.options.error(e)}},disable:function(){this.form.find(".geo-field").remove();this.allowSubmit()},preventSubmit:function(){var e=this;jQuery(".geo-throbber",this.form).css("visibility","visible");this.topForm.find("[type=submit]").prop("disabled",true);this.topForm.bind("submit.geoForm",function(){return false});setTimeout(function(){e.allowSubmit.call(e)},6e3)},allowSubmit:function(){jQuery(".geo-throbber",this.form).css("visibility","hidden");this.topForm.find("[type=submit]").prop("disabled",false);this.topForm.unbind("submit.geoForm")},geocode:function(){if(this.geocoding){return false}this.geocoding=true;var e=this,t=new google.maps.Geocoder;if(e.address==jQuery(".geo-address",e.form).val()){e.geocoding=false;return true}this.preventSubmit();t.geocode({address:jQuery(".geo-address",e.form).val()},function(t,o){e.geocoding=false;if("OK"!=o){e.allowSubmit();return}t.sort(geoForm.geocodeSort);e.setFields(t[0].geometry);e.allowSubmit();e.address=jQuery(".geo-address",e.form).val();if(e.map){e.centerMap()}});return false},reverseGeocode:function(e){var t=this,o=new google.maps.Geocoder;o.geocode({latLng:e},function(e,o){if("OK"!=o)return;e.sort(geoForm.geocodeSort);t.form.find(".geo-address").val(e[0].formatted_address);t.address=jQuery(".geo-address",t.form).val()})},drawCircle:function(e,t,o,i){if(this.accuracyCircle){this.accuracyCircle.setMap()}this.accuracyBound=new google.maps.LatLngBounds;var s=[];var a=o/6378.8;var r=Math.PI/180*t.lat();var n=Math.PI/180*t.lng();i=i||24;var c=360/i;for(var l=0;l<361;l=l+c){var h=Math.PI/180*l;var u=Math.asin(Math.sin(r)*Math.cos(a)+Math.cos(r)*Math.sin(a)*Math.cos(h));var d=Math.atan2(Math.sin(h)*Math.sin(a)*Math.cos(r),Math.cos(a)-Math.sin(r)*Math.sin(u));var f=(n-d+Math.PI)%(2*Math.PI)-Math.PI;var g=new google.maps.LatLng(parseFloat(u*180/Math.PI),parseFloat(f*180/Math.PI));s.push(g);this.accuracyBound.extend(g)}if(jQuery.browser.msie){return}this.accuracyCircle=new google.maps.Polygon({paths:s,strokeColor:"#FF0000",strokeOpacity:.5,strokeWeight:2,fillColor:"#FF0000",fillOpacity:.2});this.accuracyCircle.setMap(e)},distance:function(e,t){var o=(t.lat()-e.lat())*Math.PI/180,i=(t.lng()-e.lng())*Math.PI/180,s=Math.sin(o/2)*Math.sin(o/2)+Math.cos(e.lat()*Math.PI/180)*Math.cos(t.lat()*Math.PI/180)*Math.sin(i/2)*Math.sin(i/2);return 6371e3*2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s))}};jQuery(function(e){if(!geoForm.geolocation){if(!google.loader.ClientLocation){return}geoForm.geolocation={getCurrentPosition:function(e,t,o){e({coords:{latitude:google.loader.ClientLocation.latitude,longitude:google.loader.ClientLocation.longitude}})}}}e(".hide-if-no-geo").show();e(".hide-if-geo").hide()});